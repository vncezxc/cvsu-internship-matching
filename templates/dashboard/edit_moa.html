{% extends "dashboard/base_dashboard.html" %}
{% block dashboard_title %}Edit MOA{% endblock %}

{% block dashboard_content %}
<style>
  html, body {
    height: 100%;
    margin: 0;
    padding: 0;
  }
  .fullpage-editor-container {
    width: 100vw;
    min-height: 100vh;
    margin: 0;
    padding: 0;
    background: #f8f9fa;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: flex-start;
  }
  #onlyoffice-editor {
    width: 100vw;
    min-height: 85vh;
    height: 85vh;
    max-width: 100vw;
    border: 1px solid #ccc;
    border-radius: 6px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    background: #fff;
  }
  .d-flex.justify-content-end {
    margin-top: 1rem;
  }
  @media (max-width: 768px) {
    #onlyoffice-editor {
      min-height: 60vh;
      height: 60vh;
    }
    .d-flex.justify-content-end {
      flex-direction: column;
      gap: 0.5rem;
      align-items: stretch;
    }
  }
</style>

<div class="fullpage-editor-container">
  <h3 class="mb-4">Edit MOA Document: {{ required_doc.name }}</h3>

  {% if connection_status %}
    <p>Status: {{ connection_status }}</p>
  {% endif %}

  {% if request.user.is_coordinator or request.user.is_student %}
    <div class="alert alert-info" style="word-break:break-all;">
      <strong>DEBUG:</strong> OnlyOffice document URL:<br>
      <code>{{ document_url }}</code>
    </div>
    <!-- OnlyOffice Editor Embed -->
    <div id="onlyoffice-editor"></div>

    <div class="d-flex justify-content-end mt-3">
      <button class="btn btn-success me-2" onclick="docEditor.save(); return false;">Save Changes</button>
      {% if request.user.is_coordinator %}
        <a href="{% url 'dashboard:required_documents_list' %}" class="btn btn-secondary">Cancel</a>
      {% else %}
        <a href="{% url 'dashboard:student_documents' %}" class="btn btn-secondary">Cancel</a>
      {% endif %}
    </div>

    <!-- OnlyOffice API JS -->
    <script src="{{ onlyoffice_url }}/web-apps/apps/api/documents/api.js"></script>
    <script>
      document.addEventListener("DOMContentLoaded", function() {
        try {
          // Determine permissions based on editor_mode
          const isEditable = {% if editor_mode == 'edit' %}true{% else %}false{% endif %};

          const config = {
            document: {
              fileType: "{{ file_type|default:'docx' }}",
              key: "{{ document_key }}",
              title: "{{ required_doc.name }}",
              url: "{{ document_url }}",
              permissions: {
                edit: isEditable,
                download: true,
                print: true,
                review: isEditable,
                comment: isEditable,
                fillForms: true
              }
            },
            editorConfig: {
              mode: "{{ editor_mode }}",
              lang: "en",
              callbackUrl: "{{ BASE_URL }}/dashboard/required-documents/{{ required_doc.id }}/onlyoffice-callback/",
              customization: {
                autosave: true,
                compactToolbar: false,
                feedback: false,
                help: false,
                toolbarNoTabs: false
              },
              user: {
                id: "{{ request.user.id }}",
                name: "{{ request.user.get_full_name }}"
              }
            },

            token: "{{ token }}",
            height: "100%",
            width: "100%"
          };
          

          window.docEditor = new DocsAPI.DocEditor("onlyoffice-editor", config);
          console.log("OnlyOffice editor initialized successfully.");
        } catch (err) {
          console.error("OnlyOffice editor initialization failed:", err);
        }
      });
    </script>
  {% else %}
    <p class="text-danger">You do not have permission to edit this document.</p>
  {% endif %}
</div>
{% endblock %}
