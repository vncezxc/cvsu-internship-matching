{% extends 'dashboard/base_dashboard.html' %}
{% block dashboard_title %}Edit MOA{% endblock %}
{% block dashboard_content %}
<style>
  .editable-run {
    background: #fff8b3;
    border-bottom: 1px dashed #e6b800;
    padding: 2px 4px;
    cursor: pointer;
    transition: background 0.2s;
    position: relative;
  }
  .editable-run:after {
    content: '\270E'; /* pencil icon */
    font-size: 0.9em;
    color: #e6b800;
    margin-left: 4px;
    vertical-align: middle;
    opacity: 0.7;
  }
  .editable-run:focus {
    outline: 2px solid #e6b800;
    background: #fff3a1;
  }
</style>

<div class="container py-4">
  <h3 class="mb-4">Edit MOA Document</h3>
    {% if request.user.is_coordinator or request.user.is_student %}
      <!-- OnlyOffice Document Editor Embed for Coordinator and Student -->
      <div id="onlyoffice-editor" style="height:800px;"></div>
      <div class="d-flex justify-content-end mt-3">
        <button class="btn btn-success me-2" onclick="docEditor.save(); return false;">Save Changes</button>
        {% if request.user.is_coordinator %}
          <a href="{% url 'dashboard:required_documents_list' %}" class="btn btn-secondary">Cancel</a>
        {% else %}
          <a href="{% url 'dashboard:student_documents' %}" class="btn btn-secondary">Cancel</a>
          <form method="post" style="display:inline; margin-left:10px;">
            {% csrf_token %}
            <input type="hidden" name="reset_moa" value="1" />
            <button type="submit" class="btn btn-danger" onclick="return confirm('Are you sure you want to reset the MOA to its original template? This will erase all your changes.');">Reset MOA</button>
          </form>
        {% endif %}
      </div>
      <script type="text/javascript" src="{{ onlyoffice_url }}web-apps/apps/api/documents/api.js"></script>
      <script type="text/javascript">
        var docEditor = new DocsAPI.DocEditor("onlyoffice-editor", {
          "document": {
            "fileType": "docx",
            "key": "{{ required_doc.id }}",
            "title": "{{ required_doc.name }}",
            "url": "{{ docx_url }}"
          },
          "editorConfig": {
            "mode": "{{ editor_mode }}",
            "lang": "en",
            "callbackUrl": "" // Optionally set a callback URL for saving
          },
          "token": "{{ token }}",
          "height": "800px",
          "width": "100%"
        });
      </script>
    {% endif %}
{% endblock %}
