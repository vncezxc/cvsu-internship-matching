{% extends "dashboard/base_dashboard.html" %}
{% load static %}

{% block content %}
<div class="container mt-4">
    <h3>Edit Document: {{ required_doc.name }}</h3>
    <p>Status: {{ connection_status }}</p>

    <div id="onlyoffice-editor" style="height: 80vh; width: 100%; border: 1px solid #ccc;"></div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{{ onlyoffice_url }}/web-apps/apps/api/documents/api.js"></script>
<script>
document.addEventListener("DOMContentLoaded", function() {
    const docKey = "{{ document_key }}";
    const token = "{{ token }}";
    const fileType = "{{ file_type|default:'docx' }}";
    const documentUrl = "{{ document_url }}";
    const editorMode = "{{ editor_mode }}";

    const config = {
        "document": {
            "fileType": fileType,
            "key": docKey,
            "title": "{{ required_doc.name }}",
            "url": documentUrl,
            "permissions": {
                "edit": editorMode === "edit",
                "download": true,
                "print": true,
                "review": editorMode === "edit",
                "comment": editorMode === "edit",
                "fillForms": true
            }
        },
        "editorConfig": {
            "mode": editorMode,
            "lang": "en",
            "callbackUrl": "{{ request.scheme }}://{{ request.get_host }}{% url 'dashboard:onlyoffice_callback' %}",
            "customization": {
                "autosave": true,
                "compactToolbar": false,
                "feedback": false,
                "help": false,
                "toolbarNoTabs": false
            },
            "user": {
                "id": "{{ request.user.id }}",
                "name": "{{ request.user.get_full_name }}"
            }
        },
        "token": token,
        "height": "100%",
        "width": "100%"
    };

    try {
        const docEditor = new DocsAPI.DocEditor("onlyoffice-editor", config);
        console.log("OnlyOffice editor initialized successfully.");
    } catch (err) {
        console.error("OnlyOffice editor initialization failed:", err);
    }
});
</script>
{% endblock %}
