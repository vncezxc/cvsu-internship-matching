{% extends "dashboard/base_dashboard.html" %}
{% block dashboard_title %}Edit MOA{% endblock %}

{% block dashboard_content %}
<style>
  .moa-editor-card {
    max-width: 1100px;
    margin: 2rem auto 2rem auto;
    background: #fff;
    border-radius: 12px;
    box-shadow: 0 2px 16px rgba(0,0,0,0.08);
    padding: 2.5rem 2rem 2rem 2rem;
    display: flex;
    flex-direction: column;
    align-items: stretch;
  }
  .moa-editor-header {
    display: flex;
    flex-direction: row;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 1.5rem;
  }
  .moa-editor-title {
    font-size: 2rem;
    font-weight: 600;
    color: #333;
    margin: 0;
  }
  .moa-editor-status {
    font-size: 1rem;
    color: #388e3c;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }
  #onlyoffice-editor {
    width: 100%;
    min-width: 300px;
    height: 700px;
    border: 1px solid #e0e0e0;
    border-radius: 6px;
    background: #fafbfc;
    margin-bottom: 1.5rem;
    box-shadow: 0 1px 6px rgba(0,0,0,0.04);
  }
  .moa-editor-actions {
    display: flex;
    justify-content: flex-end;
    gap: 0.75rem;
    margin-top: 0.5rem;
  }
  @media (max-width: 900px) {
    .moa-editor-card {
      padding: 1rem 0.5rem 1rem 0.5rem;
      max-width: 100vw;
    }
    #onlyoffice-editor {
      height: 400px;
    }
  }
</style>

<div class="moa-editor-card">
  <div class="moa-editor-header">
    <span class="moa-editor-title">Edit MOA Document: {{ required_doc.name }}</span>
    {% if connection_status %}
      <span class="moa-editor-status">Status: <span style="font-size:1.2em;">{% if 'Connected' in connection_status %}✅{% else %}❌{% endif %}</span> {{ connection_status }}</span>
    {% endif %}
  </div>
  {% if request.user.is_coordinator or request.user.is_student %}
    <!-- OnlyOffice Editor Embed -->
    <div id="onlyoffice-editor"></div>
    <div class="moa-editor-actions">
      <button class="btn btn-success" onclick="docEditor.save(); return false;">Save Changes</button>
      {% if request.user.is_coordinator %}
        <a href="{% url 'dashboard:required_documents_list' %}" class="btn btn-secondary">Cancel</a>
      {% else %}
        <a href="{% url 'dashboard:student_documents' %}" class="btn btn-secondary">Cancel</a>
      {% endif %}
    </div>
    <script src="{{ onlyoffice_url }}/web-apps/apps/api/documents/api.js"></script>
    <script>
      document.addEventListener("DOMContentLoaded", function() {
        try {
          // Determine permissions based on editor_mode
          const isEditable = {% if editor_mode == 'edit' %}true{% else %}false{% endif %};
          const config = {
            document: {
              fileType: "{{ file_type|default:'docx' }}",
              key: "{{ document_key }}",
              title: "{{ required_doc.name }}",
              url: "{{ document_url }}",
              permissions: {
                edit: isEditable,
                download: true,
                print: true,
                review: isEditable,
                comment: isEditable,
                fillForms: true
              }
            },
            editorConfig: {
              mode: "{{ editor_mode }}",
              lang: "en",
              callbackUrl: "{{ BASE_URL }}/dashboard/required-documents/{{ required_doc.id }}/onlyoffice-callback/",
              customization: {
                autosave: true,
                compactToolbar: false,
                feedback: false,
                help: false,
                toolbarNoTabs: false
              },
              user: {
                id: "{{ request.user.id }}",
                name: "{{ request.user.get_full_name }}"
              }
            },
            token: "{{ token }}",
            height: "700px",
            width: "100%"
          };
          window.docEditor = new DocsAPI.DocEditor("onlyoffice-editor", config);
        } catch (err) {
          console.error("OnlyOffice editor initialization failed:", err);
        }
      });
    </script>
  {% else %}
    <p class="text-danger">You do not have permission to edit this document.</p>
  {% endif %}
</div>
{% endblock %}
