{% extends 'base.html' %}
{% load static %}

{% block title %}Chat with {{ chat_title }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/emoji-picker-element/1.10.2/emoji-picker-element.min.css" />
<style>
    .chat-container {
        height: calc(100vh - 200px);
        min-height: 500px;
        display: flex;
        flex-direction: column;
        background: linear-gradient(135deg, #f9f9f9 0%, #e6ffe6 100%);
        border-radius: 1rem;
        animation: fadeIn 0.7s;
    }
    
    .chat-messages {
        flex: 1;
        overflow-y: auto;
        padding: 1rem;
        animation: fadeInUp 0.7s;
    }
    
    .message {
        max-width: 75%;
        margin-bottom: 1rem;
        clear: both;
        display: flex;
        align-items: flex-end;
        transition: box-shadow 0.2s;
    }
    
    .message.sent {
        flex-direction: row-reverse;
        float: right;
        animation: slideInRight 0.4s;
    }
    
    .message.received {
        float: left;
        animation: slideInLeft 0.4s;
    }
    
    .avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        object-fit: cover;
        margin: 0 0.5rem;
        background: #eee;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        font-size: 1.2rem;
        color: #fff;
    }
    
    .message-content {
        padding: 0.75rem 1.2rem;
        border-radius: 1rem;
        box-shadow: 0 2px 8px rgba(0,109,56,0.07);
        min-width: 60px;
        word-break: break-word;
    }
    
    .sent .message-content {
        background: linear-gradient(90deg, #006d38 80%, #f9b233 100%);
        color: white;
        border-top-right-radius: 0;
    }
    
    .received .message-content {
        background-color: #f1f3f5;
        border-top-left-radius: 0;
    }
    
    .message-meta {
        font-size: 0.75rem;
        color: #6c757d;
        margin-top: 0.25rem;
        text-align: right;
    }
    
    .sent .message-meta {
        text-align: left;
    }
    
    .typing-indicator {
        font-size: 0.9rem;
        color: #888;
        margin: 0.5rem 0 0.5rem 3rem;
        font-style: italic;
        animation: fadeIn 0.5s;
    }
    
    .emoji-btn {
        background: none;
        border: none;
        font-size: 1.5rem;
        cursor: pointer;
        margin-right: 0.5rem;
    }
    
    .attachment-preview {
        max-width: 120px;
        max-height: 120px;
        margin-right: 0.5rem;
        border-radius: 0.5rem;
        border: 1px solid #eee;
        display: none;
    }
    
    .input-group {
        align-items: center;
    }
    
    .btn-primary, .btn-outline-primary {
        background-color: #006d38 !important;
        border-color: #006d38 !important;
    }
    
    .btn-primary:hover, .btn-outline-primary:hover {
        background-color: #f9b233 !important;
        border-color: #f9b233 !important;
        color: #fff !important;
    }
    
    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }
    
    @keyframes fadeInUp {
        from { opacity: 0; transform: translateY(30px); }
        to { opacity: 1; transform: translateY(0); }
    }
    
    @keyframes slideInRight {
        from { opacity: 0; transform: translateX(40px); }
        to { opacity: 1; transform: translateX(0); }
    }
    
    @keyframes slideInLeft {
        from { opacity: 0; transform: translateX(-40px); }
        to { opacity: 1; transform: translateX(0); }
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row mb-3">
        <div class="col">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{% url 'chat:chat_list' %}">My Chats</a></li>
                    <li class="breadcrumb-item active" aria-current="page">{{ chat_title }}</li>
                </ol>
            </nav>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-8 mx-auto">
            <div class="card shadow-sm">
                <div class="card-header bg-white">
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="d-flex align-items-center">
                            <img src="{{ chat_avatar|default:'/static/images/default_avatar.png' }}" class="avatar me-2" alt="avatar">
                            <div>
                                <h5 class="mb-0">{{ chat_title }}</h5>
                                <div class="text-muted small">
                                    <span class="participant-status {% if is_participant_online %}status-online{% else %}status-offline{% endif %}"></span>
                                    {% if is_participant_online %}Online{% else %}Offline{% endif %}
                                </div>
                            </div>
                        </div>
                        <div>
                            <div class="dropdown">
                                <button class="btn btn-sm btn-light" type="button" id="chatOptionsDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                                    <i class="fas fa-ellipsis-v"></i>
                                </button>
                                <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="chatOptionsDropdown">
                                    <li><a class="dropdown-item" href="#"><i class="fas fa-search me-2"></i> Search messages</a></li>
                                    <li><a class="dropdown-item" href="#"><i class="fas fa-bell-slash me-2"></i> Mute notifications</a></li>
                                    <li><hr class="dropdown-divider"></li>
                                    <li><a class="dropdown-item text-danger" href="#"><i class="fas fa-trash me-2"></i> Delete conversation</a></li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="chat-container">
                    <div class="chat-messages" id="chat-messages">
                        {% if messages %}
                            {% for message in messages %}
                                <div class="message {% if message.sender == request.user %}sent{% else %}received{% endif %}">
                                    {% if message.sender == request.user %}
                                        <img src="{{ request.user.profile.avatar.url|default:'/static/images/default_avatar.png' }}" class="avatar" alt="avatar">
                                    {% else %}
                                        <img src="{{ chat_avatar|default:'/static/images/default_avatar.png' }}" class="avatar" alt="avatar">
                                    {% endif %}
                                    <div>
                                        <div class="message-content">{{ message.content|linebreaksbr }}</div>
                                        <div class="message-meta">
                                            <span>{{ message.timestamp|date:"h:i A" }}</span>
                                            {% if message.sender == request.user and message.is_read %}
                                                <i class="fas fa-check-double ms-1 text-primary" title="Read"></i>
                                            {% elif message.sender == request.user %}
                                                <i class="fas fa-check ms-1 text-muted" title="Sent"></i>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                                <div style="clear: both;"></div>
                            {% endfor %}
                        {% else %}
                            <div class="text-center py-5">
                                <div class="mb-3">
                                    <i class="far fa-comment-dots fa-4x text-muted"></i>
                                </div>
                                <h5>No messages yet</h5>
                                <p class="text-muted">Start the conversation by sending a message below.</p>
                            </div>
                        {% endif %}
                        <div id="typing-indicator" class="typing-indicator" style="display:none;">{{ chat_title }} is typing...</div>
                    </div>
                    
                    <div class="p-3 bg-light">
                        <form id="chat-form" class="d-flex align-items-center">
                            <button type="button" class="emoji-btn" id="emoji-btn">ðŸ˜Š</button>
                            <input type="file" id="attachment-input" style="display:none;" accept="image/*">
                            <img id="attachment-preview" class="attachment-preview" src="#" alt="Attachment Preview">
                            <div class="input-group flex-grow-1">
                                <input type="text" id="chat-message-input" class="form-control" placeholder="Type a message..." autocomplete="off">
                                <button type="button" class="btn btn-outline-secondary" id="attach-button"><i class="fas fa-paperclip"></i></button>
                                <button type="submit" id="chat-message-submit" class="btn btn-primary"><i class="fas fa-paper-plane"></i></button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% block extra_js %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/emoji-picker-element/1.10.2/emoji-picker-element.min.js"></script>
<script>
const roomName = "{{ room.id }}";
const userId = {{ request.user.id }};
let chatSocket = null;
const messagesContainer = document.getElementById('chat-messages');
const typingIndicator = document.getElementById('typing-indicator');
let typingTimeout;

if (roomName && roomName !== 'None' && roomName !== '') {
    chatSocket = new WebSocket('ws://' + window.location.host + '/ws/chat/' + roomName + '/');
}

document.addEventListener('DOMContentLoaded', function() {
    if (messagesContainer) messagesContainer.scrollTop = messagesContainer.scrollHeight;
    if (document.getElementById('chat-message-input')) document.getElementById('chat-message-input').focus();
    // Emoji picker
    const emojiBtn = document.getElementById('emoji-btn');
    let emojiPicker;
    emojiBtn.addEventListener('click', function(e) {
        e.preventDefault();
        if (!emojiPicker) {
            emojiPicker = document.createElement('emoji-picker');
            emojiPicker.style.position = 'absolute';
            emojiPicker.style.bottom = '60px';
            emojiPicker.style.left = '30px';
            emojiPicker.addEventListener('emoji-click', function(event) {
                document.getElementById('chat-message-input').value += event.detail.unicode;
            });
            document.body.appendChild(emojiPicker);
        } else {
            emojiPicker.remove();
            emojiPicker = null;
        }
    });
    // Hide emoji picker on click outside
    document.addEventListener('click', function(e) {
        if (emojiPicker && !emojiBtn.contains(e.target) && !emojiPicker.contains(e.target)) {
            emojiPicker.remove();
            emojiPicker = null;
        }
    });
    // Attachment preview
    const attachBtn = document.getElementById('attach-button');
    const attachmentInput = document.getElementById('attachment-input');
    const attachmentPreview = document.getElementById('attachment-preview');
    attachBtn.addEventListener('click', function(e) {
        e.preventDefault();
        attachmentInput.click();
    });
    attachmentInput.addEventListener('change', function() {
        const file = this.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                attachmentPreview.src = e.target.result;
                attachmentPreview.style.display = 'inline-block';
            };
            reader.readAsDataURL(file);
        } else {
            attachmentPreview.style.display = 'none';
        }
    });
    // Typing indicator
    if (chatSocket) {
        document.getElementById('chat-message-input').addEventListener('input', function() {
            chatSocket.send(JSON.stringify({ 'type': 'typing', 'user_id': userId }));
        });
        // Submit message on Enter
        document.getElementById('chat-message-input').onkeypress = function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                document.getElementById('chat-message-submit').click();
            }
        };
        // Submit message form
        document.getElementById('chat-form').onsubmit = function(e) {
            e.preventDefault();
            const messageInputDom = document.getElementById('chat-message-input');
            const message = messageInputDom.value.trim();
            if (message) {
                chatSocket.send(JSON.stringify({ 'type': 'chat_message', 'message': message }));
                messageInputDom.value = '';
            }
        };
    }
});
chatSocket.onmessage = function(e) {
    const data = JSON.parse(e.data);
    if (data.type === 'chat_message') {
        addMessage(data.message, data.sender_id === userId, data.timestamp, data.sender_avatar);
    } else if (data.type === 'user_status') {
        updateUserStatus(data.user_id, data.status);
    } else if (data.type === 'typing') {
        // Only show typing indicator if the other user is typing
        if (data.user_id !== userId) {
            showTypingIndicator();
        }
    }
};
chatSocket.onclose = function(e) {
    console.error('Chat socket closed unexpectedly');
};
function addMessage(content, isSent, timestamp = null, senderAvatar = null) {
    const currentTime = timestamp || new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${isSent ? 'sent' : 'received'}`;
    const avatarUrl = senderAvatar || (isSent ? '{{ request.user.profile.avatar.url|default:'/static/images/default_avatar.png' }}' : '{{ chat_avatar|default:'/static/images/default_avatar.png' }}');
    messageDiv.innerHTML = `
        <img src="${avatarUrl}" class="avatar" alt="avatar">
        <div>
            <div class="message-content">${content.replace(/\n/g, '<br>')}</div>
            <div class="message-meta">
                <span>${currentTime}</span>
                ${isSent ? '<i class="fas fa-check ms-1 text-muted" title="Sent"></i>' : ''}
            </div>
        </div>
    `;
    messagesContainer.appendChild(messageDiv);
    const clearDiv = document.createElement('div');
    clearDiv.style.clear = 'both';
    messagesContainer.appendChild(clearDiv);
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
    typingIndicator.style.display = 'none';
}
function updateUserStatus(userId, status) {
    const statusIndicator = document.querySelector('.participant-status');
    if (statusIndicator) {
        if (status === 'online') {
            statusIndicator.classList.add('status-online');
            statusIndicator.classList.remove('status-offline');
            statusIndicator.nextElementSibling.textContent = 'Online';
        } else {
            statusIndicator.classList.add('status-offline');
            statusIndicator.classList.remove('status-online');
            statusIndicator.nextElementSibling.textContent = 'Offline';
        }
    }
}
function showTypingIndicator() {
    typingIndicator.style.display = 'block';
    clearTimeout(typingTimeout);
    typingTimeout = setTimeout(() => {
        typingIndicator.style.display = 'none';
    }, 2000);
}
</script>
{% endblock %}
{% endblock %}


