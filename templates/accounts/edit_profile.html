{% extends 'base.html' %}
{% load crispy_forms_tags %}
{% load static %}
{% block title %}Edit Profile{% endblock %}
{% block content %}
<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0">Edit Profile</h4>
                </div>
                <div class="card-body">
                    {% if is_student %}
                    <form method="post" enctype="multipart/form-data">
                        {% csrf_token %}
                        <h5 class="mb-3">Personal Information</h5>
                        <div class="row">
                            <div class="col-md-6">{{ form.student_id|as_crispy_field }}</div>
                            <div class="col-md-6">{{ form.first_name|as_crispy_field }}</div>
                        </div>
                        <div class="row">
                            <div class="col-md-12">{{ form.last_name|as_crispy_field }}</div>
                        </div>
                        <div class="row">
                            <div class="col-md-12">{{ form.email|as_crispy_field }}</div>
                        </div>
                        <div class="row">
                            <!-- Avatar removed, only use profile_image -->
                            <div class="col-md-6">
                                {% if profile.profile_image %}
                                    <div class="mb-2 text-center">
                                        <img src="{{ profile.profile_image.url }}" alt="Current Profile Image" class="rounded img-fluid" style="max-width: 100px;">
                                        <div class="small text-muted">Current Profile Image</div>
                                    </div>
                                {% endif %}
                                {{ form.profile_image|as_crispy_field }}
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">{{ form.phone_number|as_crispy_field }}</div>
                            <div class="col-md-6">{{ form.cv|as_crispy_field }}</div>
                        </div>
                        <h5 class="mt-4 mb-3">Address</h5>
                        <div class="row">
                            <div class="col-md-6">{{ form.street|as_crispy_field }}</div>
                            <div class="col-md-6">{{ form.barangay|as_crispy_field }}</div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">{{ form.city|as_crispy_field }}</div>
                            <div class="col-md-6">{{ form.province|as_crispy_field }}</div>
                        </div>
                        <h5 class="mt-4 mb-3">Academic</h5>
                        <div class="row">
                            <div class="col-md-4">{{ form.course|as_crispy_field }}</div>
                            <div class="col-md-4">{{ form.section|as_crispy_field }}</div>
                            <div class="col-md-4">{{ form.year_level|as_crispy_field }}</div>
                        </div>
                        <h5 class="mt-4 mb-3">Skills</h5>
                        <div class="mb-3">
                            <label class="form-label">Suggested Skills</label>
                            <div id="skill-chips" class="mb-2"></div>
                            <label for="custom-skill-input" class="form-label">Add Custom Skill</label>
                            <div class="input-group mb-2">
                                <input type="text" id="custom-skill-input" class="form-control" placeholder="Type a skill and press Enter">
                                <button type="button" id="add-custom-skill" class="btn btn-outline-primary">Add</button>
                            </div>
                            <div id="selected-skills" class="mb-2"></div>
                            <input type="hidden" name="skills_json" id="id_skills_json">
                        </div>
                        <h5 class="mt-4 mb-3">Location</h5>
                        <input type="hidden" name="latitude" id="id_latitude" value="{{ form.latitude.value|default_if_none:'' }}">
                        <input type="hidden" name="longitude" id="id_longitude" value="{{ form.longitude.value|default_if_none:'' }}">
                        <div id="student-map" style="height: 350px; margin-bottom: 1rem;"></div>
                        <div class="mt-3 text-end">
                            <a href="{% url 'accounts:profile' %}" class="btn btn-secondary me-2">Cancel</a>
                            <button type="submit" class="btn btn-primary">Save Changes</button>
                        </div>
                    </form>
                    {% elif is_adviser %}
                    <form method="post" enctype="multipart/form-data">
                        {% csrf_token %}
                        <h5 class="mb-3">Personal Information</h5>
                        <div class="row">
                            <div class="col-md-6">
                                {% if profile.profile_image %}
                                    <div class="mb-2 text-center">
                                        <img src="{{ profile.profile_image.url }}" alt="Current Profile Image" class="rounded img-fluid" style="max-width: 100px;">
                                        <div class="small text-muted">Current Profile Image</div>
                                    </div>
                                {% endif %}
                                {{ form.profile_image|as_crispy_field }}
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">{{ form.first_name|as_crispy_field }}</div>
                            <div class="col-md-6">{{ form.last_name|as_crispy_field }}</div>
                        </div>
                        <div class="row">
                            <div class="col-md-12">{{ form.email|as_crispy_field }}</div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">{{ form.phone_number|as_crispy_field }}</div>
                            <div class="col-md-6">{{ form.department|as_crispy_field }}</div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">{{ form.office|as_crispy_field }}</div>
                            <div class="col-md-6">{{ form.year_levels|as_crispy_field }}</div>
                        </div>
                        <div class="row">
                            <div class="col-md-12">{{ form.courses|as_crispy_field }}</div>
                        </div>
                        <div class="row">
                            <div class="col-md-12">{{ form.sections|as_crispy_field }}</div>
                        </div>
                        <div class="mt-3 text-end">
                            <a href="{% url 'accounts:adviser_profile' %}" class="btn btn-secondary me-2">Cancel</a>
                            <button type="submit" class="btn btn-primary">Save Changes</button>
                        </div>
                    </form>
                    <!-- Removed duplicate generic form for adviser and coordinator -->
                    {% elif is_coordinator %}
                    <form method="post" enctype="multipart/form-data">
                        {% csrf_token %}
                        <h5 class="mb-3">Personal Information</h5>
                        <div class="row">
                            <div class="col-md-6">
                                {% if profile.profile_image %}
                                    <div class="mb-2 text-center">
                                        <img src="{{ profile.profile_image.url }}" alt="Current Profile Image" class="rounded img-fluid" style="max-width: 100px;">
                                        <div class="small text-muted">Current Profile Image</div>
                                    </div>
                                {% endif %}
                                {{ form.profile_image|as_crispy_field }}
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">{{ form.first_name|as_crispy_field }}</div>
                            <div class="col-md-6">{{ form.last_name|as_crispy_field }}</div>
                        </div>
                        <div class="row">
                            <div class="col-md-12">{{ form.email|as_crispy_field }}</div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">{{ form.phone_number|as_crispy_field }}</div>
                            <div class="col-md-6">{{ form.department|as_crispy_field }}</div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">{{ form.office|as_crispy_field }}</div>
                        </div>
                        <div class="mt-3 text-end">
                            <a href="{% url 'accounts:coordinator_profile' %}" class="btn btn-secondary me-2">Cancel</a>
                            <button type="submit" class="btn btn-primary">Save Changes</button>
                        </div>
                    </form>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% if is_student %}
<script>
  var COURSE_SKILLS_MAP = {{ course_skill_map|safe }};
  var INITIAL_SELECTED_SKILLS = [
    {% for skill in profile.skills.all %}{ id: {{ skill.id }}, name: "{{ skill.name|escapejs }}" },{% endfor %}
  ];
  document.addEventListener('DOMContentLoaded', function() {
    var latInput = document.getElementById('id_latitude');
    var lngInput = document.getElementById('id_longitude');
    if (!latInput || !lngInput) return; // Only run if fields exist
    var lat = parseFloat(latInput.value) || 14.2294;
    var lng = parseFloat(lngInput.value) || 120.9367;
    var map = L.map('student-map').setView([lat, lng], 15);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: 'Â© OpenStreetMap'
    }).addTo(map);
    var marker = L.marker([lat, lng], {draggable:true}).addTo(map);
    function updateInputs(e) {
      var pos = e.latlng || marker.getLatLng();
      latInput.value = pos.lat.toFixed(6);
      lngInput.value = pos.lng.toFixed(6);
      marker.setLatLng(pos);
    }
    map.on('click', updateInputs);
    marker.on('dragend', updateInputs);
  });
</script>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="{% static 'js/skills_autoload.js' %}"></script>
{% endif %}
{% endblock %}
