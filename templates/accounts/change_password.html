{% extends 'dashboard/base_dashboard.html' %}
{% load crispy_forms_tags %} 
{% block dashboard_title %}Change Password{% endblock %}

{% block dashboard_content %}
<div class="row justify-content-center mt-5">
    <div class="col-12 col-md-7 col-lg-5">
        <div class="card shadow-sm">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">Change Password</h5>
            </div>
            <div class="card-body">
                {% if messages %}
                <div class="mb-3">
                    {% for message in messages %}
                    <div class="alert alert-{{ message.tags }} alert-dismissible fade show">
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                    {% endfor %}
                </div>
                {% endif %}
                
                <form method="post" novalidate>
                    {% csrf_token %}
                    
                    {% if form.non_field_errors %}
                        <div class="alert alert-danger">
                            {{ form.non_field_errors }}
                        </div>
                    {% endif %}
                    
                    <!-- Current Password -->
                    <div class="mb-3">
                        <label for="id_old_password" class="form-label">Current Password</label>
                        <input type="password" 
                               name="old_password" 
                               id="id_old_password" 
                               class="form-control {% if form.old_password.errors %}is-invalid{% endif %}"
                               required>
                        {% if form.old_password.errors %}
                            <div class="invalid-feedback">
                                {{ form.old_password.errors|striptags }}
                            </div>
                        {% endif %}
                    </div>
                    
                    <!-- New Password -->
                    <div class="mb-3">
                        <label for="id_new_password1" class="form-label">New Password</label>
                        <input type="password" 
                               name="new_password1" 
                               id="id_new_password1" 
                               class="form-control {% if form.new_password1.errors %}is-invalid{% endif %}"
                               required>
                        {% if form.new_password1.help_text %}
                            <small class="form-text text-muted">{{ form.new_password1.help_text }}</small>
                        {% endif %}
                        {% if form.new_password1.errors %}
                            <div class="invalid-feedback">
                                {{ form.new_password1.errors|striptags }}
                            </div>
                        {% endif %}
                    </div>
                    
                    <!-- Confirm New Password -->
                    <div class="mb-4">
                        <label for="id_new_password2" class="form-label">Confirm New Password</label>
                        <input type="password" 
                               name="new_password2" 
                               id="id_new_password2" 
                               class="form-control {% if form.new_password2.errors %}is-invalid{% endif %}"
                               required>
                        {% if form.new_password2.errors %}
                            <div class="invalid-feedback">
                                {{ form.new_password2.errors|striptags }}
                            </div>
                        {% endif %}
                    </div>
                    
                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-key me-2"></i>Change Password
                        </button>
                        <a href="{% url 'accounts:profile' %}" class="btn btn-outline-secondary">
                            <i class="fas fa-arrow-left me-2"></i>Back to Profile
                        </a>
                    </div>
                </form>
            </div>
            <div class="card-footer text-center">
                <small class="text-muted">
                    <i class="fas fa-info-circle me-1"></i>
                    Password must be at least 8 characters and not too common.
                </small>
            </div>
        </div>
        
        <!-- Password Strength Tips -->
        <div class="card mt-3 border-info">
            <div class="card-body">
                <h6 class="card-title text-info mb-3">
                    <i class="fas fa-shield-alt me-2"></i>Password Strength Tips
                </h6>
                <div class="row">
                    <div class="col-6">
                        <ul class="small mb-0">
                            <li>Minimum 8 characters</li>
                            <li>Uppercase letters</li>
                            <li>Lowercase letters</li>
                        </ul>
                    </div>
                    <div class="col-6">
                        <ul class="small mb-0">
                            <li>Numbers (0-9)</li>
                            <li>Special characters</li>
                            <li>Not personal info</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- JavaScript for password visibility toggle -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Create show/hide password toggle
    const passwordFields = document.querySelectorAll('input[type="password"]');
    
    passwordFields.forEach(field => {
        // Create wrapper
        const wrapper = document.createElement('div');
        wrapper.className = 'position-relative';
        
        // Wrap the field
        field.parentNode.insertBefore(wrapper, field);
        wrapper.appendChild(field);
        
        // Create toggle button
        const toggle = document.createElement('button');
        toggle.type = 'button';
        toggle.className = 'btn btn-sm btn-outline-secondary position-absolute end-0 top-50 translate-middle-y me-2';
        toggle.style.zIndex = '5';
        toggle.innerHTML = '<i class="fas fa-eye"></i>';
        
        // Add toggle functionality
        toggle.addEventListener('click', function() {
            const type = field.getAttribute('type') === 'password' ? 'text' : 'password';
            field.setAttribute('type', type);
            
            // Toggle eye icon
            const icon = this.querySelector('i');
            if (type === 'text') {
                icon.classList.remove('fa-eye');
                icon.classList.add('fa-eye-slash');
            } else {
                icon.classList.remove('fa-eye-slash');
                icon.classList.add('fa-eye');
            }
        });
        
        wrapper.appendChild(toggle);
    });
    
    // Real-time password validation
    const newPassword1 = document.getElementById('id_new_password1');
    const newPassword2 = document.getElementById('id_new_password2');
    
    if (newPassword1 && newPassword2) {
        function validatePasswords() {
            if (newPassword1.value && newPassword2.value) {
                if (newPassword1.value !== newPassword2.value) {
                    newPassword2.classList.add('is-invalid');
                    newPassword2.classList.remove('is-valid');
                } else {
                    newPassword2.classList.remove('is-invalid');
                    newPassword2.classList.add('is-valid');
                }
            }
        }
        
        newPassword1.addEventListener('input', validatePasswords);
        newPassword2.addEventListener('input', validatePasswords);
    }
});
</script>

<style>
/* Custom styles for password fields */
.form-control.is-valid {
    border-color: #198754;
    padding-right: calc(1.5em + 0.75rem);
    background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 8 8'%3e%3cpath fill='%23198754' d='M2.3 6.73L.6 4.53c-.4-1.04.46-1.4 1.1-.8l1.1 1.4 3.4-3.8c.6-.63 1.6-.27 1.2.7l-4 4.6c-.43.5-.8.4-1.1.1z'/%3e%3c/svg%3e");
    background-repeat: no-repeat;
    background-position: right calc(0.375em + 0.1875rem) center;
    background-size: calc(0.75em + 0.375rem) calc(0.75em + 0.375rem);
}

/* Password toggle button positioning */
.position-relative input {
    padding-right: 45px;
}
</style>
{% endblock %}